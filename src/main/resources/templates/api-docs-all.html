<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>API Dashboard - MyShortUrl</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        /*<![CDATA[*/
        var appBaseUrl = /*[[${baseUrl}]]*/ 'http://localhost:8080/'; // Fallback URL
        /*]]>*/
        $(document).ready(function() {
            $('#generateTokenBtn').click(function() {
                generateToken();
            });

            $('#copyTokenBtn').click(function() {
                copyToken();
            });

            $('#apiEndpoint').change(function() {
                updateRequestInputFields();
                $('#apiResponse').empty();
                updateCurlInstructions();
            });

            $('#sendRequestBtn').click(function() {
                sendApiRequest();
            });

            updateRequestInputFields(); // Initialize on page load
        });

        function generateToken() {
            var username = $('#username').val();
            var password = $('#password').val();
            var authRequest = {
                username: username,
                password: password
            };

            $.ajax({
                url: '/authenticate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(authRequest),
                success: function(data) {
                    var token = 'Bearer ' + data.jwt;
                    $('#tokenValue').val(token);
                    $('#copyTokenBtn').prop('disabled', false);
                    console.log("Token generated successfully");
                },
                error: function(response) {
                    console.error('Error generating token:', response);
                    alert('Failed to generate token. ' + response.responseJSON.error);
                }
            });
        }

        function copyToken() {
            var copyText = document.getElementById("tokenValue");
            copyText.select();
            document.execCommand("copy");
            alert("Copied the token: " + copyText.value);
        }

        function updateRequestInputFields() {
            var selectedOption = $('#apiEndpoint').val();
            $('#apiRequestInputs').empty(); // Clear existing inputs

            switch (selectedOption) {
                case '/api/url/generateCustom':
                    $('#apiRequestInputs').append('<div class="form-group"><label for="originalUrl">Original URL:</label><input type="text" id="originalUrl" class="form-control"></div><div class="form-group"><label for="backHalf">Back Half:</label><input type="text" id="backHalf" class="form-control"></div>');
                    break;
                case '/api/url/generateRandom':
                    $('#apiRequestInputs').append('<div class="form-group"><label for="originalUrlRandom">Original URL:</label><input type="text" id="originalUrlRandom" class="form-control"></div>');
                    break;
                case '/api/url/disableUrl':
                    $('#apiRequestInputs').append('<div class="form-group"><label for="shortUrlInput">Short URL:</label><input type="text" id="shortUrlInput" class="form-control"></div>');
                    break;
                default:
                    break;
            }
        }

        function sendApiRequest() {
            var token = $('#tokenValue').val();
            var endpoint = $('#apiEndpoint').val();
            var requestData = {};
            var requestType = 'POST';

            if (endpoint === '/api/url/generateCustom') {
                requestData = {
                    originalUrl: $('#originalUrl').val(),
                    backHalf: $('#backHalf').val()
                };
            } else if (endpoint === '/api/url/generateRandom') {
                requestData = {
                    originalUrl: $('#originalUrlRandom').val()
                };
            } else if (endpoint === '/api/url/disableUrl') {
                requestData = {
                    shortUrl: $('#shortUrlInput').val()
                };
            } else {
                requestType = 'GET';
            }

            $.ajax({
                url: endpoint,
                type: requestType,
                contentType: 'application/json',
                headers: { 'Authorization': token },
                data: requestType === 'POST' ? JSON.stringify(requestData) : {},
                success: function(response) {
                    $('#apiResponse').text(JSON.stringify(response, null, 2));
                },
                error: function(response) {
                    $('#apiResponse').text('Error: ' + JSON.stringify(response.responseJSON, null, 2));
                }
            });
        }


        function updateCurlInstructions() {
            var selectedOption = $('#apiEndpoint').val();
            var baseUrl =appBaseUrl;
            var curlCommand = "curl -X ";
            var endpoint = baseUrl + selectedOption;
            var token = "<YOUR_TOKEN>";
            var dataString = "";

            switch (selectedOption) {
                case '/api/url/generateCustom':
                    curlCommand += "POST ";
                    dataString = '{"originalUrl": "<originalUrl>", "backHalf": "<backHalf>"}';
                    break;
                case '/api/url/generateRandom':
                    curlCommand += "POST ";
                    dataString = '{"originalUrl": "<originalUrl>"}';
                    break;
                case '/api/url/disableUrl':
                    curlCommand += "POST ";
                    dataString = '{"shortUrl": "<shortUrl>"}';
                    break;
                default:
                    curlCommand += "GET ";
                    break;
            }

            curlCommand += endpoint + " \\\n" +
                "-H 'Authorization: Bearer " + token + "' \\\n" +
                "-H 'Content-Type: application/json' \\\n" +
                "-d '" + dataString + "'";
            $('#curlInstructions').text(curlCommand);
        }

    </script>
</head>
<body>
<header class="bg-info text-white py-3">
    <div class="container d-flex justify-content-between">
        <h1>API Dashboard</h1>
        <a th:href="@{/login}" class="btn btn-primary">Back to home</a>
    </div>
</header>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" class="form-control" required>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" class="form-control" required>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>&nbsp;</label>
                <button id="generateTokenBtn" class="btn btn-success btn-block">Generate New Token</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="form-group">
                <input type="text" id="tokenValue" class="form-control" readonly>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <button id="copyTokenBtn" class="btn btn-outline-secondary btn-block" disabled>Copy</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Test API Endpoints</h5>
            <select id="apiEndpoint" class="form-control mb-2">
                <option value="" disabled selected>Select an API Endpoint</option>
                <option value="/api/url/active">Get Active URLs</option>
                <option value="/api/url/inactive">Get Inactive URLs</option>
                <option value="/api/url/generateRandom">Generate Random Short URL</option>
                <option value="/api/url/generateCustom">Generate Custom Short URL</option>
                <option value="/api/url/disableUrl">Disable URL</option>
            </select>
            <div id="apiRequestInputs"></div>
            <button id="sendRequestBtn" class="btn btn-primary">Send Request</button>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">CURL Instructions</h5>
            <pre id="curlInstructions" class="bg-light p-3"></pre>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <h5 class="card-title">Response</h5>
            <pre id="apiResponse" class="bg-light p-3"></pre>
        </div>
    </div>
</div>
</body>
</html>
